# Invisible Heavy Exploit Fix

Patches the game functions so live Heavies cannot create ragdolls and get into a state where
they are alive and invisible.  Exploit discovered 2020-01-09.

Also logs the incident in `addons/sourcemod/logs/exploit_heavy_invis.log` for review.

Plugin requires [detour-supported DHooks][dhooks].

[dhooks]: https://forums.alliedmods.net/showpost.php?p=2588686&postcount=589

## Low-Level Explanation

Without getting into details on how to trigger the exploit while officially unpached, the player
receives an animation event with the event `AE_RAGDOLL`.  This is
[handled in unmodified SDK code][handle-anim], spawning a ragdoll entity then forcing the player
into its `DeathThink` think function.

A stack trace when it occurs is below:

<pre>
#0  0xb0a89056 in CTFPlayer::CreateRagdollEntity(bool, bool, bool, bool, bool, bool, bool, bool, int, bool) () from bin/server_srv.so
#1  0xb0a8b221 in CTFPlayer::CreateRagdollEntity() () from bin/server_srv.so
#2  0xb07f48b0 in CBasePlayer::HandleAnimEvent(animevent_t*) () from bin/server_srv.so
#3  0xb0ab945c in CTFPlayer::HandleAnimEvent(animevent_t*) () from bin/server_srv.so
#4  0xb0647644 in CAnimationLayer::DispatchAnimEvents(CBaseAnimating*, CBaseAnimating*) () from bin/server_srv.so
#5  0xb0649e93 in CBaseAnimatingOverlay::DispatchAnimEvents(CBaseAnimating*) () from bin/server_srv.so
#6  0xb080353e in CBasePlayer::PostThink() () from bin/server_srv.so
#7  0xb0ab3ed4 in CTFPlayer::PostThink() () from bin/server_srv.so
#8  0xa525bec5 in __SourceHook_MFHCls_PostThink::Func() () from addons/sourcemod/extensions/sdkhooks.ext.2.tf2.so
#9  0x1ba47330 in ?? ()
#10 0xb0814dab in CPlayerMove::RunCommand(CBasePlayer*, CUserCmd*, IMoveHelper*) () from bin/server_srv.so
#11 0xb080c4b3 in CBasePlayer::PlayerRunCommand(CUserCmd*, IMoveHelper*) () from bin/server_srv.so
#12 0xb0ab45fd in CTFPlayer::PlayerRunCommand(CUserCmd*, IMoveHelper*) () from bin/server_srv.so
</pre>

For whatever reason, this exploit still allows the player to aim and use weapons, but they are
not visible, nor can they move.

The patch uses some basic checks to prevent the function from running on the aforementioned
living Heavies when called with the correct event.

Without in-depth knowledge on the animation event system (which appears to be tied to models?),
I cannot assure that this is free of all false positives.

That said, it looks like the only player animation sequence it is used on is Heavy's `diesimple`
sequence, so I suspect that no other animation legitimately needs this.  Heck, the decompiled
model even suggests that it's not actually supposed to be called:

<pre>
$sequence "diesimple" {
	"heavy_animations_anims\diesimple.smd"
	activity "ACT_DIESIMPLE" 1
	{ event AE_RAGDOLL 52 "temp" }
	fadein 0.2
	fadeout 0.2
	fps 30
	...
}
</pre>

Still not sure how the exploit manages to activate this sequence, but I think this is as far as
I'll look into it.

[handle-anim]: https://github.com/alliedmodders/hl2sdk/blob/0ef5d3d482157bc0bb3aafd37c08961373f87bfd/game/server/player.cpp#L8953-L8966
