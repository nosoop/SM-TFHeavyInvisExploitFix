# Invisible Heavy Exploit Fix

Patches the game functions so players cannot create ragdolls and get into a state where they are
alive and invisible.  Exploit discovered 2020-01-09.

This bug / exploit has been filed as [ValveSoftware/Source-1-Games#3103][issue3103].

[issue3103]: https://github.com/ValveSoftware/Source-1-Games/issues/3103

## Installation

There are two methods of installation:

- Plugin installation:  Uses [detour-supported DHooks][dhooks] to block only living Heavies from
triggering the code path.  Also logs the incident in
`addons/sourcemod/logs/exploit_heavy_invis.log` for review, in case you wanted to deal with
them later.
    1. Install `tf2.exploit_heavy_fix.txt` in `gamedata/`.
    2. Install `tf_heavy_invis_fix.smx` somewhere under `plugins/`.
    3. Load the `tf_heavy_invis_fix` plugin.
- Function patch installation:  Uses [Source Scramble][sourcescramble] and its manager plugin
to patch the function to always return early instead of running the code in the branch.
This blocks the animation event entirely.  Zero performance impact on the function call.
    1. Make sure that the `sourcescramble_manager` plugin is up and running.
    2. Install `tf2.exploit_heavy_fix.txt` in `gamedata/`.
    3. Install `tf2.exploit_heavy_fix.cfg` in `configs/sourcescramble/`.
    4. Reload the `sourcescramble_manager` plugin.

[dhooks]: https://forums.alliedmods.net/showpost.php?p=2588686&postcount=589
[sourcescramble]: https://github.com/nosoop/SMExt-SourceScramble

## Low-Level Explanation

Without getting into details on how to trigger the exploit while officially unpached, the player
receives an animation event with the event `AE_RAGDOLL`.  This is
[handled in unmodified SDK code][handle-anim], spawning a ragdoll entity then forcing the player
into its `DeathThink` think function.

A stack trace when it occurs is below:

<pre>
#0  0xb0a89056 in CTFPlayer::CreateRagdollEntity(bool, bool, bool, bool, bool, bool, bool, bool, int, bool) () from bin/server_srv.so
#1  0xb0a8b221 in CTFPlayer::CreateRagdollEntity() () from bin/server_srv.so
#2  0xb07f48b0 in CBasePlayer::HandleAnimEvent(animevent_t*) () from bin/server_srv.so
#3  0xb0ab945c in CTFPlayer::HandleAnimEvent(animevent_t*) () from bin/server_srv.so
#4  0xb0647644 in CAnimationLayer::DispatchAnimEvents(CBaseAnimating*, CBaseAnimating*) () from bin/server_srv.so
#5  0xb0649e93 in CBaseAnimatingOverlay::DispatchAnimEvents(CBaseAnimating*) () from bin/server_srv.so
#6  0xb080353e in CBasePlayer::PostThink() () from bin/server_srv.so
#7  0xb0ab3ed4 in CTFPlayer::PostThink() () from bin/server_srv.so
#8  0xa525bec5 in __SourceHook_MFHCls_PostThink::Func() () from addons/sourcemod/extensions/sdkhooks.ext.2.tf2.so
#9  0x1ba47330 in ?? ()
#10 0xb0814dab in CPlayerMove::RunCommand(CBasePlayer*, CUserCmd*, IMoveHelper*) () from bin/server_srv.so
#11 0xb080c4b3 in CBasePlayer::PlayerRunCommand(CUserCmd*, IMoveHelper*) () from bin/server_srv.so
#12 0xb0ab45fd in CTFPlayer::PlayerRunCommand(CUserCmd*, IMoveHelper*) () from bin/server_srv.so
</pre>

For whatever reason, this exploit still allows the player to aim and use weapons, but they are
not visible, nor can they move.

Without in-depth knowledge on the animation event system (which appears to be tied to models?),
I cannot assure that the hotfix is free of all false positives.  It's also not fixing the
underlying problem with the animation layers.

That said, it looks like the only player animation it is used on is Heavy's `diesimple`
sequence, so I suspect that no other animation legitimately needs `AE_RAGDOLL`.  Heck, the
decompiled model even suggests that it's not actually supposed to be called:

<pre>
$sequence "diesimple" {
	"heavy_animations_anims\diesimple.smd"
	activity "ACT_DIESIMPLE" 1
	{ event AE_RAGDOLL 52 "temp" }
	fadein 0.2
	fadeout 0.2
	fps 30
	...
}
</pre>

Still not sure how the exploit manages to activate this sequence, but I think this is as far as
I'll look into it.

[handle-anim]: https://github.com/alliedmodders/hl2sdk/blob/0ef5d3d482157bc0bb3aafd37c08961373f87bfd/game/server/player.cpp#L8953-L8966
