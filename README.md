# Invisible Heavy Exploit Fix

Patches the game functions so live Heavies cannot create ragdolls and get into a state where
they are alive and invisible.  Exploit discovered 2020-01-09.

Also logs the incident in `addons/sourcemod/logs/exploit_heavy_invis.log` for review.

Plugin requires [detour-supported DHooks][dhooks].

[dhooks]: https://forums.alliedmods.net/showpost.php?p=2588686&postcount=589

## Low-Level Explanation

Without getting into details on how to trigger the exploit while officially unpached, the player
receives an animation event with the event `AE_RAGDOLL`.  This is
[handled in unmodified SDK code][handle-anim], spawning a ragdoll entity then forcing the player
into its `DeathThink` think function.

For whatever reason, this exploit still allows the player to aim and use weapons, but they are
not visible, nor can they move.

The patch uses some basic checks to prevent the function from running on the aforementioned
living Heavies.

Without in-depth knowledge on the animation event system (which appears to be tied to models?),
I cannot assure that this is free of all false positives.

[handle-anim]: https://github.com/alliedmodders/hl2sdk/blob/0ef5d3d482157bc0bb3aafd37c08961373f87bfd/game/server/player.cpp#L8953-L8966
